<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atacadão-TV</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" th:href="@{/img/css/bootstrap.min.css}">
  <script th:src="@{/img/js/bootstrap.bundle.min.js}"></script>
  <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico?v=1}" />
  <!-- Meta tags para configuração do sistema -->
  <meta name="auto-update-interval" content="30s">
  <meta name="auto-update-url" th:content="@{/{categoria}/{numero}(categoria=${categoria}, numero=${numero})}">
  <meta name="auto-update-target" content="#main-content, body">
  <style>

    @font-face {
      font-family: 'knewave';
      src: url('/api-tv/img/webfonts/Knewave-Regular.ttf') format('truetype');
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden; /* Remove scroll */
    }

    .video-container,
    .image-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #000;
      position: relative;
    }

    video, img {

      width: 100vw;
      height: 100vh;
      object-fit: contain;
    }

    .produto-item {
      border: 1px solid transparent;
      padding: 0.25rem 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .produtos {
      height: 80vh;
      background-color: rgba(10,10,10,0.9);
      backdrop-filter: blur(12px);
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      border-radius: 1rem;
      overflow-y: auto;
      padding: 1rem;
    }

    /* Informações da TV */
    .tv-info {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .tv-info.priority-active {
      display: none;
      background: rgba(40, 167, 69, 0.9);
      border: 2px solid #28a745;
      animation: glow 2s infinite alternate;
    }
    /* Debug info */
    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
      font-family: monospace;
      width: 50%;
      display: none;
    }

    /* Status verificação */
    .status-verificacao {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }

    .status-verificacao.ativo {
      display: none;
      background: rgba(40, 167, 69, 0.9);
      border: 2px solid #28a745;
    }


    .oferta-container {

      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #000 !important;

    }

    .oferta{
      width: 45%;
      height: 90vh;
      background-color: #fff90d;
      padding-inline: 70px;
      border-radius: 10px;
      position: relative;
    }

    .oferta > h2 {
      font-size: 7rem !important;
      font-weight: bold;
      color: #FF0D23;
    }

    .logo{
      height: auto;
      width: 5vw;
      position:absolute;
      bottom: 0px;
      right: 10px;
    }

    .nome-oferta {
      width: 100%;
      font-weight: 350;
      font-size: 4rem;
      font-family: 'knewave', sans-serif;
    }

    .preco-oferta {
      color: #ff0d23;
      font-size: 12rem;
      font-weight: 100;
      font-family: 'knewave', sans-serif;
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); }
      to { box-shadow: 0 0 20px rgba(40, 167, 69, 0.8); }
    }

    /* Status de agendamento */
    .agendamento-status {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .agendamento-status.ativo {
      display: none;
      background: rgba(40, 167, 69, 0.9);
      border: 2px solid #28a745;
    }

    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
      font-weight: bold;
    }

    .loading-overlay.show {
      display: none;
    }

    /* CSS Tailwind reduzido (mantendo apenas o necessário) */
    .text-center { text-align: center; }
    .text-white { color: white; }
    .text-gray-500 { color: #6b7280; }
    .text-warning { color: #ffc107; }
    .fs-1 { font-size: 2.5rem; }
    .fw-bold { font-weight: bold; }
    .fw-normal { font-weight: normal; }
    .text-uppercase { text-transform: uppercase; }
    .text-nowrap { white-space: nowrap; }
    .d-flex { display: flex; }
    .flex-column { flex-direction: column; }
    .align-items-center { align-items: center; }
    .align-items-end { align-items: flex-end; }
    .align-items-start { align-items: flex-start; }
    .justify-content-center { justify-content: center; }
    .justify-content-start { justify-content: flex-start; }
    .justify-content-between { justify-content: space-between; }
    .gap-1 { gap: 0.25rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .w-100 { width: 100%; }
    .col-4 { width: 33.333333%; }
    .col-8 { width: 66.666667%; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .px-lg-5 { padding-left: 3rem; padding-right: 3rem; }
    .pt-2 { padding-top: 0.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .mt-4 { margin-top: 1.5rem; }
    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 0.25rem; }
    .m-0 { margin: 0; }
    .bg-dark { background-color: #000; }
    .bg-opacity-50 { background-color: rgba(33, 37, 41, 0.5); }
    .rounded-3 { border-radius: 0.5rem; }
    .rounded-4 { border-radius: 1rem; }
    .border { border: 1px solid; }
    .border-2 { border-width: 2px; }
    .border-warning { border-color: #ffc107; }
    .small { font-size: 0.875rem; }
    .text-end { text-align: right; }

    @media (min-width: 1024px) {
      .px-lg-5 { padding-left: 3rem; padding-right: 3rem; }
    }

    .produto-item {
      display: none;
      transition: opacity 1s ease;
    }
    .produto-item.mostrar {
      display: flex;
    }

    #ofertaArea{
      margin-top: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .linha{
      background-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body th:style="'background-image: url(' + @{/img/background/{cat}.png(cat=${categoria})} + ');
                 background-size: cover;
                 background-repeat: no-repeat;
                 background-color: #000;'" id="app">
<!-- Debug Info -->
<div id="debug-info" class="debug-info show">
</div>

<!-- TV Info -->
<div id="tv-info" class="tv-info">
  <div><strong>📺 TV:</strong> <span id="tv-display">Loading...</span></div>
  <div><strong>📊 Status:</strong> <span id="tv-status">Iniciando...</span></div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div>🔄 Carregando...</div>
</div>

<div id="main-content">
  <!-- Imagem -->
  <div class="image-container" th:id="divImagem"  th:align="center">
    <img id="imagem" alt="Conteúdo de imagem">
  </div>

  <!-- Video -->
  <div class="video-container" th:id="divVideo" th:align="center">
    <video id="video" controls playsinline autoplay muted preload="auto" loop>
      <source id="sourceVideo" type="video/mp4">
    </video>
    <input type="hidden" id="videoCaminho" />
  </div>

  <div class="oferta-container" th:id="divOferta " th:align="center">
    <div class="oferta">
      <h2 class="">OFERTA</h2>
      <div id="ofertaArea">

      </div>
    </div>
  </div>

  <!-- Tabela de Preços -->
  <div class="d-flex gap-4 tabela-preco" th:id="tabelaPreco" >
    <div class="col-4"></div>
    <div class="col-8 d-flex flex-column gap-4 px-4 px-lg-5 mt-4">
      <input type="hidden" name="idAgendamentoPrioritario" id="idAgendamentoPrioritario" value="0">
      <!-- Cabeçalho Categoria -->
      <div class="w-100 pt-2 d-flex align-items-center">
        <div class="d-flex justify-content-center align-items-center w-100 bg-dark bg-opacity-50 rounded-4 border border-2 border-warning py-2">
          <h1 class="fs-1 fw-bold text-warning text-uppercase" th:text="${descCategoria}">Departamento</h1>
        </div>
      </div>

      <!-- Lista de Produtos -->
      <div class="w-100">
        <div class="produtos border border-2 border-warning py-2" id="lista-produtos">
          <!-- Produto renderizado via Thymeleaf -->

          <!-- Caso nenhum produto -->
          <div th:if="${#lists.isEmpty(produtos)}" class="text-center text-gray-500">
            <h3>📦 Nenhum produto encontrado</h3>
            <p>Aguardando produtos para <span th:text="${categoria}">categoria</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts de configuração inseridos via Thymeleaf -->
<script th:inline="javascript">
  // Configurações da TV passadas pelo controller
  const TV_CONFIG = {
    categoria: /*[[${categoria}]]*/ 'categoria',
    numero: /*[[${numero}]]*/ 0,
    baseUrl: /*[[${baseUrl}]]*/ 'http://localhost:8081/api-tv/',
    intervaloVerificacao: /*[[${intervaloVerificacao}]]*/ 30000,
    tipoConteudo: /*[[${tipoConteudo}]]*/ 1,
    conteudoTitulo: /*[[${conteudoTitulo}]]*/ '',
    conteudoDescricao: /*[[${conteudoDescricao}]]*/ '',
    agendamentosAtivos: /*[[${agendamentosAtivos}]]*/ 0,
    qtdeLinhas: /*[[${qtdeLinhas}]]*/ 8,
    caminhoArquivo: /*[[${caminhoCompletoArquivo}]]*/ '',
    repeticaoPreco: 0,
    serverIP: /*[[${serverIP}]]*/ 'localhost',
    debugDisplay: /*[[${debugDisplay}]]*/ 'none'
  };
  function getServerURL() {
    const hostname = window.location.hostname;
    const port = window.location.port || '8081';

    // Detecta se está rodando localmente
    const isLocal = hostname === 'localhost' ||
            hostname === '127.0.0.1' ||
            hostname.startsWith('192.168.') ||
            hostname.startsWith('10.') ||
            hostname.startsWith('172.');
    if (isLocal && hostname === 'localhost') {
      return `localhost`;
    } else {
      // Para TV ou acesso remoto, usa o IP atual
      return `${TV_CONFIG.serverIP}`;
    }
  }

  console.log('🎯 TV Configurada:', TV_CONFIG);
  console.log('📦 Categoria atual:', TV_CONFIG.categoria);
  console.log('📋 Agendamentos ativos:', TV_CONFIG.agendamentosAtivos);
</script>
<!-- Script principal da TV -->
<script>
  let verificacaoInterval = null;
  let contadorInterval = null;
  let rolagemInterval = null;
  let isRedirecting = false;
  let contadorVerificacao = 30;
  let totalVerificacoes = 0;
  let totalErros = 0;

  function atualizarDebugInfo() {
    const debugElements = {
      'debug-tv': `${TV_CONFIG.categoria}/${TV_CONFIG.numero}`,
      'debug-content': `Tipo ${TV_CONFIG.tipoConteudo} - ${TV_CONFIG.conteudoTitulo || 'Sem título'}`,
      'debug-countdown': `${contadorVerificacao}s`,
      'debug-checks': totalVerificacoes,
      'debug-errors': totalErros,
      'tv-display': `${TV_CONFIG.categoria}/${TV_CONFIG.numero}`,
      'debug-last-check': new Date().toLocaleTimeString('pt-BR')
    };

    Object.entries(debugElements).forEach(([id, value]) => {
      const element = document.getElementById(id);
      if (element) element.textContent = value;
    });
  }

  function logDebug(message, level = 'info') {
    const timestamp = new Date().toLocaleTimeString('pt-BR');
    const prefix = level === 'error' ? '❌' : level === 'warn' ? '⚠️' : level === 'success' ? '✅' : 'ℹ️';
    console.log(`${prefix} [${timestamp}] ${message}`);

    // Atualiza status no debug
    const statusElement = document.getElementById('debug-status');
    if (statusElement) {
      statusElement.textContent = message;
      statusElement.style.color = level === 'error' ? '#ff6b6b' : level === 'success' ? '#51cf66' : '#fff';
    }
  }

  // === FUNÇÃO DE CONTAGEM REGRESSIVA ===
  function iniciarContador() {
    if (contadorInterval) {
      clearInterval(contadorInterval);
    }

    contadorInterval = setInterval(() => {
      if (!isRedirecting) {
        contadorVerificacao--;
        atualizarDebugInfo();

        if (contadorVerificacao <= 0) {
          contadorVerificacao = 30; // Reset
        }
      }
    }, 1000);
  }

  // Atualiza status visual
  function atualizarStatus(texto, ativo = false) {
    const statusTexto = document.getElementById('status-texto');
    const statusDiv = document.getElementById('status-verificacao');
    const ultimaVerificacao = document.getElementById('ultima-verificacao');

    if (statusTexto) statusTexto.textContent = texto;
    if (ultimaVerificacao) ultimaVerificacao.textContent = new Date().toLocaleTimeString('pt-BR');

    if (statusDiv) {
      if (ativo) {
        statusDiv.classList.add('ativo');
      } else {
        statusDiv.classList.remove('ativo');
      }
    }
  }

  // Atualiza horário atual
  function atualizarHorario() {
    const agora = new Date();
    const elemento = document.getElementById('current-time');
    if (elemento) {
      elemento.textContent = agora.toLocaleTimeString('pt-BR');
    }
  }

  // Registra que a TV está ativa
  async function registrarAtividade() {
    try {
      const url = `/api-tv/api/tv/${TV_CONFIG.categoria}/${TV_CONFIG.numero}/abrir`;

      await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          timestamp: new Date().toISOString(),
          tipoConteudo: TV_CONFIG.tipoConteudo,
          titulo: TV_CONFIG.conteudoTitulo,
          categoria: TV_CONFIG.categoria
        })
      });
      console.log('📊 Atividade registrada para', TV_CONFIG.categoria + '/' + TV_CONFIG.numero);
      atualizarStatus('Registrado', true);
    } catch (error) {
      console.warn('⚠ Erro ao registrar atividade:', error.message);
      atualizarStatus('Erro no registro', false);
    }
  }

  // Verifica se ainda deve exibir este conteúdo
  async function verificarStatusAgendamento() {
    if (isRedirecting) {
      console.log('🔄 Já está redirecionando, pulando verificação');
      return;
    }

    totalVerificacoes++;
    console.log(`Iniciando verificação #${totalVerificacoes}`, 'info');

    try {
      /*const statusUrl = `${TV_CONFIG.baseUrl}/api/tv/${TV_CONFIG.categoria}/${TV_CONFIG.numero}/status`;*/
      const statusUrl = `/api-tv/api/tv/${TV_CONFIG.categoria}/${TV_CONFIG.numero}/status`;

      console.log(`Consultando: ${statusUrl}`, 'info');

      const response = await fetch(statusUrl, {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-cache',
          'Pragma': 'no-cache'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const status = await response.json();
      console.log(status);
      console.log(`Status recebido - Deve exibir: ${status.deveExibirConteudo}, Agendamentos: ${status.agendamentosAtivos}`, 'info');

      // Atualiza interface
      atualizarStatus(status, true);

      // VERIFICAÇÃO 1: Se não deve mais exibir conteúdo
      if (!status.deveExibirConteudo) {
        console.log('⚠️ DEVE SAIR - Não deve mais exibir conteúdo', 'warn');
        redirecionarParaStandby('Sem agendamentos ativos');
        return;
      }

      // VERIFICAÇÃO 2: Se mudou o agendamento atual (splash vs principal)
      if (status.agendamentoAtual) {

        const tituloAtual = TV_CONFIG.conteudoTitulo || '';
        const novoTitulo = status.agendamentoAtual.titulo || '';

        if (tituloAtual !== novoTitulo) {
          console.log(`🔄 MUDANÇA DE AGENDAMENTO DETECTADA:`, 'warn');
          console.log(`   Atual: "${tituloAtual}"`, 'warn');
          console.log(`   Novo:  "${novoTitulo}"`, 'warn');
          recarregarConteudo('Agendamento mudou');
          return;
        }
      }

      // Reset contador após verificação bem-sucedida
      contadorVerificacao = 30;
      console.log(`✅ Verificação #${totalVerificacoes} concluída - Tudo OK`, 'success');
      atualizarDebugInfo();

    } catch (error) {
      totalErros++;
      console.log(`❌ Erro na verificação #${totalVerificacoes}: ${error.message}`, 'error');
      atualizarStatus(error.message, null);
      atualizarDebugInfo();
    }
  }

  // Redireciona para standby
  function redirecionarParaStandby(motivo = 'Standby necessário') {
    if (isRedirecting) return;

    isRedirecting = true;
    console.log(`🔄 REDIRECIONANDO PARA STANDBY: ${motivo}`, 'warn');

    // Limpa todos os intervals
    clearAllIntervals();

    // Mostra loading
    const loading = document.getElementById('loading-overlay');
    if (loading) {
      loading.classList.add('show');
      loading.innerHTML = `<div>🔄 ${motivo}<br>Redirecionando...</div>`;
    }

    // Redireciona
    setTimeout(() => {
      window.location.href = `/tv?categoria=${TV_CONFIG.categoria}&numero=${TV_CONFIG.numero}`;
    }, 2000);
  }

  function recarregarConteudo(motivo = 'Atualizando conteúdo') {
    if (isRedirecting) return;

    isRedirecting = true;
    console.log(`🔄 RECARREGANDO CONTEÚDO: ${motivo}`, 'warn');

    // Limpa todos os intervals
    clearAllIntervals();

    // Mostra loading
    const loading = document.getElementById('loading-overlay');
    if (loading) {
      loading.classList.add('show');
      loading.innerHTML = `<div>🔄 ${motivo}<br>Recarregando...</div>`;
    }
  }

  function clearAllIntervals() {
    if (verificacaoInterval) {
      clearInterval(verificacaoInterval);
      verificacaoInterval = null;
    }
    if (contadorInterval) {
      clearInterval(contadorInterval);
      contadorInterval = null;
    }
    if (rolagemInterval) {
      clearInterval(rolagemInterval);
      rolagemInterval = null;
    }
  }

  function adicionarOferta(produto) {
    console.log(produto);
    const ofertaArea = document.getElementById('ofertaArea');
    ofertaArea.innerHTML = `
    <div>
        <h3 class="nome-oferta">${produto.nome.trim()}</h3>
        <div style="margin-top: 0px" class="d-flex flex-column align-items-start justify-content-center" margin-top: 0px>
        <span style="font-size: 2rem;">R$</span>
        <p class="preco-oferta mb-1">
           ${produto.preco.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
        </p>
         </div>
<span style="margin-top: 0px; top: 0px; font-weight: 10; font-size: 2rem;" >(${produto.abreviacaoUM})</span>
           <div>

            <img class="logo" src="/api-tv/img/background/logo-atacadao.png"/>
            </div>
    </div>`;
  }

  // === ROLAGEM DE PRODUTOS COM FADE ===
  function inicializarRolagemProdutos(produtos) {
    const tabelaProdutos = document.getElementById('lista-produtos');
      tabelaProdutos.innerHTML=``;
    produtos.forEach((produto, index) => {
      var validaProduto = produto.nome != null && produto.nome != "";
      if(validaProduto){
        tabelaProdutos.innerHTML +=`
        <div class="produto-item rounded-3 small ${index % 2 == 0 ? 'linha' : ''}">
            <div th:if="${produto.abreviacaoUM != null}" class="d-flex flex-column gap-1 justify-content-start align-items-start ">
              <div class="d-flex align-items-end gap-4 ">
                <h3 class="text-white fs-2 text-nowrap m-0 fw-normal">${produto.nome != null ? produto.nome.trim() : ''}</h3>
                <h3 class="text-white fs-2 text-nowrap m-0 fw-normal">-</h3>
                <h5 class="text-white fs-1 m-0 fw-normal" >${produto.abreviacaoUM}</h5>
              </div>
            </div>
            <div th:if="${produto.nome != null}" class="d-flex align-items-end gap-3 text-end">
              <div>
                <p class="preco fs-1 text-white mb-0">
                  R$ <span>${produto.preco != null ? produto.preco.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : ''}</span>
                </p>
              </div>
            </div>
          </div>
        `;
      }
    })

      const items = document.querySelectorAll(".produto-item");
      if (items.length === 0) return;

      //console.log(`📦 Iniciando fade de ${items.length} produtos`, 'info');

      const step = parseInt(`${TV_CONFIG.qtdeLinhas}`, 10);
      let currentIndex = 0;
      function mostrarBloco(index) {
        // Esconde todos
        items.forEach(item => item.classList.remove("mostrar"));
        for (let i = index; i < index + step && i < items.length; i++) {
          items[i].classList.add("mostrar");
        }
      }

      // Limpa interval anterior se existir
      if (rolagemInterval) {
        clearInterval(rolagemInterval);
      }

      // Mostra primeiro bloco
      mostrarBloco(currentIndex);

      // Troca blocos a cada 8s
      rolagemInterval = setInterval(() => {
        //console.log(`📦 Entrou para verificar se exibe próximo bloco `, 'info');
        if (!isRedirecting) {
          currentIndex += step;
          if (currentIndex >= items.length) {
            currentIndex = 0; // volta para o início
          }
          mostrarBloco(currentIndex);
        }
      }, 8000);
  }

  const videoCache = {};

  function verificaTipoConteudo() {
    let idAgendamentoPrioritario = $('#idAgendamentoPrioritario').val();
    if(TV_CONFIG.tipoConteudo==3 && TV_CONFIG.repeticaoPreco >= 2 ){
      idAgendamentoPrioritario=0;
      debugLog(`🔄 Reset ID por repetição: ${idAgendamentoPrioritario} e ${TV_CONFIG.repeticaoPreco}`);
    }
    debugLog(`🔍 Verificando Agendamento. ID: ${idAgendamentoPrioritario}`);
    const server = getServerURL();
    const url = `http://${server}:8081/api-tv/interno/${TV_CONFIG.categoria}/${TV_CONFIG.numero}/${idAgendamentoPrioritario}`;
    debugLog(`📡 Chamando: ${url}`);

    // TENTATIVA 1: XMLHttpRequest
    const xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            processarRespostaSamsung(response, idAgendamentoPrioritario);
          } catch (e) {
            debugLog(`Erro ao parsear JSON: ${e.message}`);
            // FALLBACK: tenta jQuery AJAX
            tentarAjaxFallback(url, idAgendamentoPrioritario);
          }
        } else {
          debugLog(`Erro XHR: ${xhr.status} - ${xhr.statusText}`);
          // FALLBACK: tenta jQuery AJAX
          tentarAjaxFallback(url, idAgendamentoPrioritario);
        }
      }
    };
    xhr.onerror = function() {
      debugLog(`Erro de rede XHR`);
      // FALLBACK: tenta jQuery AJAX
      tentarAjaxFallback(url, idAgendamentoPrioritario);
    };
    xhr.ontimeout = function() {
      debugLog(`Timeout XHR`);
      // FALLBACK: tenta jQuery AJAX
      tentarAjaxFallback(url, idAgendamentoPrioritario);
    };
    xhr.timeout = 15000;
    xhr.open('GET', url, true);
    xhr.send();
  }

  // FALLBACK: jQuery AJAX (sua versão original)
  function tentarAjaxFallback(url, idAgendamentoPrioritario) {
    debugLog(`Fallback: tentando jQuery AJAX`);
    $.ajax({
      url: url,
      method: "GET",
      dataType: 'json',
      timeout: 15000
    })
    .done(function(response) {
      processarRespostaSamsung(response, idAgendamentoPrioritario);
    })
    .fail(function(xhr, status, error) {
      debugLog(`ERRO AJAX Final: ${status} - ${error}`);
      debugLog(`Status: ${xhr.status}`);
    });
  }

  // PROCESSA RESPOSTA COM CACHE BLOB + FALLBACKS
  function processarRespostaSamsung(response, idAgendamentoPrioritario) {
    debugLog(`Resposta recebida: ${response.length} itens`);
    debugLog(`Tipo: ${response[0].tipoConteudo}`);

    if(idAgendamentoPrioritario != response[0].idAgendamentoPrioritario){
        console.log("Mudando agendamento: "+ idAgendamentoPrioritario);
        debugLog(`🔄 Mudando agendamento: ${idAgendamentoPrioritario} → ${response[0].idAgendamentoPrioritario}`);

        $('#idAgendamentoPrioritario').val(response[0].idAgendamentoPrioritario);
        TV_CONFIG.tipoConteudo=response[0].tipoConteudo;
        TV_CONFIG.repeticaoPreco=0;
        if (response[0].tipoConteudo === 3) {
          debugLog(`📋 Carregando tabela de preços`);
          $('.tabela-preco').addClass('d-block');
          $('.tabela-preco').removeClass('d-none');
          $('.video-container').removeClass('d-block');
          $('.video-container').addClass('d-none');
          $('.image-container').removeClass('d-block');
          $('.image-container').addClass('d-none');
          $('.oferta-container').addClass('d-none');
          $('.oferta-container').removeClass('d-flex');
          console.log("**** Carregando tabela ******");
          debugLog(response[0]);
          inicializarRolagemProdutos(response);
        } else if (response[0].tipoConteudo === 2) {
          const videoUrl = response[0].caminhoImagemVideo;

          $('.video-container').addClass('d-block');
          $('.video-container').removeClass('d-none');
          $('.image-container').removeClass('d-block');
          $('.image-container').addClass('d-none');
          $('.tabela-preco').removeClass('d-block');
          $('.tabela-preco').addClass('d-none');
          $('.oferta-container').addClass('d-none');
          $('.oferta-container').removeClass('d-flex');
          debugLog(`📋 Carregando video`);
          console.log("**** Carregando video ******");
          debugLog(response[0].caminhoImagemVideo);
          console.log("SRC = " + response[0].caminhoImagemVideo);
          carregarVideoComCacheSamsung(videoUrl);
        } else if (response[0].tipoConteudo === 1) {
          debugLog(`📋 Carregando imagem`);
          $('.image-container').addClass('d-block');
          $('.image-container').removeClass('d-none');
          $('.video-container').removeClass('d-block');
          $('.video-container').addClass('d-none');
          $('.tabela-preco').removeClass('d-block');
          $('.tabela-preco').addClass('d-none');
          $('.oferta-container').addClass('d-none');
          $('.oferta-container').removeClass('d-flex');
          console.log("**** Carregando imagem ******");
          debugLog("SRC = " + response[0].caminhoImagemVideo);
          console.log("SRC = " + response[0].caminhoImagemVideo);
          $('#imagem').attr('src', response[0].caminhoImagemVideo);
        } else {
          $('.oferta-container').addClass('d-flex');
          $('.oferta-container').removeClass('d-none');
          $('.image-container').addClass('d-none');
          $('.image-container').removeClass('d-block');
          $('.video-container').removeClass('d-block');
          $('.video-container').addClass('d-none');
          $('.tabela-preco').removeClass('d-block');
          $('.tabela-preco').addClass('d-none');
          adicionarOferta(response[0]);
        }
      }else{
      TV_CONFIG.repeticaoPreco++;
    }
    debugLog(`Repetição: ${TV_CONFIG.repeticaoPreco}`);
    console.log("Repetição = " + TV_CONFIG.repeticaoPreco);
  }
  // CARREGA VÍDEO COM CACHE BLOB + FALLBACKS
  function carregarVideoComCacheSamsung(videoUrl) {
    debugLog(`SAMSUNG: Carregando vídeo com cache`);

    // Se já está em cache, usa
    if (videoCache[videoUrl]) {
      $('#sourceVideo').attr('src', videoCache[videoUrl]);
      $('#video')[0].load();
      tentarPlaySamsung($('#video')[0], 'CACHE');
      return;
    }

    // Tenta baixar para cache
    debugLog(`SAMSUNG: Forçando donwload para cache`);

    // TENTATIVA 1: XMLHttpRequest para blob
    const xhrVideo = new XMLHttpRequest();
    xhrVideo.open('GET', videoUrl, true);
    xhrVideo.responseType = 'blob';
    xhrVideo.timeout = 30000; // 30s para vídeo

    xhrVideo.onload = function() {
      if (xhrVideo.status === 200) {
        try {
          const blob = xhrVideo.response;
          const objectURL = URL.createObjectURL(blob);
          videoCache[videoUrl] = objectURL;
          debugLog(`SAMSUNG: Cache criado - ${blob.size} bytes`);

          $('#sourceVideo').attr('src', objectURL);
          $('#video')[0].load();
          tentarPlaySamsung($('#video')[0], 'CACHE');
        } catch (e) {
          debugLog(`SAMSUNG: Erro ao criar blob: ${e.message}`);
          // FALLBACK: URL direta
          carregarVideoSemCacheSamsung(videoUrl);
        }
      } else {
        debugLog(`SAMSUNG: Erro no download: ${xhrVideo.status}`);
        // FALLBACK: URL direta
        carregarVideoSemCacheSamsung(videoUrl);
      }
    };

    xhrVideo.onerror = function() {
      debugLog(`SAMSUNG: Erro de rede no download`);
      // FALLBACK: URL direta
      carregarVideoSemCacheSamsung(videoUrl);
    };

    xhrVideo.ontimeout = function() {
      debugLog(`SAMSUNG: Timeout no download`);
      // FALLBACK: URL direta
      carregarVideoSemCacheSamsung(videoUrl);
    };
    xhrVideo.send();
  }

  // FALLBACK: Carrega vídeo sem cache (URL direta)
  function carregarVideoSemCacheSamsung(videoUrl) {
    debugLog(`SAMSUNG: Carregando vídeo direto (sem cache)`);
    $('#sourceVideo').attr('src', videoUrl);
    $('#video')[0].load();
    tentarPlaySamsung($('#video')[0], 'DIRETO');
  }

  // SISTEMA ROBUSTO DE PLAY PARA SAMSUNG
  function tentarPlaySamsung(video, modo) {
    let tentativas = 0;
    const maxTentativas = 8;
    let videoCarregado = false;

    const tentarPlay = () => {
      if (tentativas >= maxTentativas || videoCarregado) {
        if (tentativas >= maxTentativas) {
          debugLog(`SAMSUNG ${modo}: Falha após ${maxTentativas} tentativas`);

          // Se era cache e falhou, tenta modo direto
          if (modo === 'CACHE') {
            debugLog(`SAMSUNG: Cache falhou, tentando modo direto`);
            // Aqui você implementaria fallback para URL original
          }
        }
        return;
      }

      tentativas++;
      debugLog(`SAMSUNG ${modo}: Tentativa de play #${tentativas}`);

      // Força configurações
      video.preload = true;
      video.muted = true;
      video.autoplay = true;
      video.loop = true;

      try {
        const playPromise = video.play();
        if (playPromise && typeof playPromise.then === 'function') {
          playPromise
                  .then(() => {
                    debugLog(`SAMSUNG ${modo}: Play OK na tentativa ${tentativas}`);
                    videoCarregado = true;
                  })
                  .catch(error => {
                    debugLog(`SAMSUNG ${modo}: Tentativa ${tentativas} falhou: ${error.message}`);
                    if (tentativas < maxTentativas) {
                      setTimeout(tentarPlay, tentativas * 500);
                    }
                  });
        } else {
          debugLog(`SAMSUNG ${modo}: Play executado (sem promise)`);
          videoCarregado = true;
        }
      } catch (e) {
        debugLog(`SAMSUNG ${modo}: Erro no play: ${e.message}`);
        if (tentativas < maxTentativas) {
          setTimeout(tentarPlay, tentativas * 500);
        }
      }
    };

    // Event listeners
    video.addEventListener('canplay', () => {
      if (!videoCarregado) setTimeout(tentarPlay, 200);
    });
    video.addEventListener('playing', () => {
      videoCarregado = true;
      debugLog(`SAMSUNG ${modo}: Reproduzindo`);
    });
    video.addEventListener('error', (e) => {
      debugLog(`SAMSUNG ${modo}: Erro no vídeo`);
    });
    // Primeira tentativa
    setTimeout(tentarPlay, 1000);
  }

  // === INICIALIZAÇÃO ===
  document.addEventListener("DOMContentLoaded", function () {
    console.log(`🎬 Iniciando TV: ${TV_CONFIG.categoria}/${TV_CONFIG.numero}`, 'info');
    console.log(`📦 Tipo de conteúdo: ${TV_CONFIG.tipoConteudo}`, 'info');
    console.log(`📋 Título: ${TV_CONFIG.conteudoTitulo}`, 'info');

    // Atualiza debug inicial
    atualizarDebugInfo();

    // Registra atividade inicial
    registrarAtividade();

    // Inicia contador visual
    iniciarContador();

    verificaTipoConteudo();

    verificacaoInterval = setInterval(() => {
      verificaTipoConteudo();
    }, 30000); // 30 segundos

    console.log('✅ TV inicializada com sucesso', 'success');
  });

  window.debugTV = function() {
    console.log('=== 🔍 DEBUG TV ===');
    console.log('Configuração:', TV_CONFIG);
    console.log('Estado redirecionamento:', isRedirecting);
    console.log('Interval verificação ativo:', verificacaoInterval !== null);
    console.log('Próxima verificação em:', contadorVerificacao + 's');
    console.log('Total verificações:', totalVerificacoes);
    console.log('Total erros:', totalErros);
    console.log('=================');
  };
</script>
<!-- Bootstrap JS -->
<script th:src="@{/img/js/popper.min.js}"></script>
<script th:src="@{/img/js/bootstrap.min.js}"></script>
<script th:src="@{/img/js/jquery-3.7.1.min.js}"></script>
<button id="exitFullscreenBtn" style="position:fixed;top:10px;right:10px;width:40px;height:40px;opacity:0;z-index:999;border:none;background:none;cursor:pointer;"></button>
<script>
    document.getElementById("exitFullscreenBtn").addEventListener("click", function () {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        }else{
          document.documentElement.requestFullscreen();
        }
    });
    function criarDebugOverlay() {
      const debugDiv = document.createElement('div');
      debugDiv.id = 'tv-debug-overlay';
      debugDiv.style.cssText = `
        position: fixed;
        top: 50px;
        right: 10px;
        background: rgba(255,0,0,0.9);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 10000;
        max-width: 600px;
        display: ${TV_CONFIG.debugDisplay};`;
      document.body.appendChild(debugDiv);
      return debugDiv;
    }

    const debugOverlay = criarDebugOverlay();

    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugOverlay.innerHTML += `<div>[${timestamp}] ${message}</div>`;

      // Limita a 30 últimas mensagens
      const lines = debugOverlay.querySelectorAll('div');
      if (lines.length > 30) {
        lines[0].remove();
      }
    }
</script>
</body>
</html>